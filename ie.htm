<!DOCTYPE html>
<html>
<head>
    <title>WebRTCAPI</title>
	<script src="socket.io.min.js"></script>
	<script src="rtcplugin.js"></script>

</head>

<body>

	<br>
	<button onclick="run()">run</button>
	<button onclick="authenticate()">authenticate</button>
	<button onclick="hangup()">hangup</button>
	<button onclick="debug()">debug</button>
	<br>
    
    <object id="videoElement"
            classid="CLSID:0E8D29CE-D2D0-459A-8009-3B34EFBC43F0"
            height=300 width=400></object>
    
	<div id='divMe'></div>
	<div id='divPeers'> </div>
	<div id='divATL'> </div>
	<div id='divSDP'> </div>
	<pre>
		<div id='divLog'> </div>
	</pre>
    <script type="text/javascript">

	var myrtcid
	,   rtcPlugin
	, 	iceServers
	, 	socket
	,   element
	,   setupCallbacks;

	window.onload = function () {

		element = document.getElementById("videoElement");
		
		socket = io.connect('dev.easyrtc.com:80');
		// socket = io.connect('172.16.40.108:8080');

		var auth = { 
			"msgType" : "authenticate", 
			"msgData" : {
				"apiVersion" : "1.0.10",
				"applicationName" : "easyrtc.audioVideo" 
			} 
		};


		setupCallbacks = function () {
			socket.emit('easyrtcAuth', auth, function (message) {

			    rtcPlugin.onicecandidate = function (candidate) {
			    	
			    	dlog("native --> onicecandidate");

			    	socket.emit ("easyrtcCmd", {
					  msgType: "candidate",
					  senderEasyrtcid: myrtcid,
					  targetEasyrtcid: rtcPlugin.remoteId,
					  msgData: {
					    type: "candidate",
					    label: candidate.sdpMLineIndex,
					    id: candidate.sdpMid,
					    candidate: candidate.candidate
					  }
					}, function (){
						// there must be a callback for this emit to work.
					});
			    };

				/* Handle displaying the button to connect to other peers... */

				myrtcid = message.msgData.easyrtcid;
				addPeerButtons(message);
				
				iceServers = message.msgData.iceConfig.iceServers;
				rtcPlugin.handleIceServers(message.msgData.iceConfig.iceServers);

				socket.on('easyrtcCmd', function (json) {

					if (json.msgData && json.msgData.type)	{		

						// cleanup sdp
						if (json.msgData.sdp) {
							var sdp = json.msgData.sdp;
							var actualnewlines = String.fromCharCode(13) + String.fromCharCode(10);
							sdp = sdp.replace(/\\r\\n/g, actualnewlines);
							sdp = sdp.replace(/\"/g, '');

							json.msgData.sdp = sdp;
							dlog("----------");
							dlog(json.msgData.sdp);
							dlog("----------");
						}	

						// don't need, could just check for sdp...
						switch(json.msgData.type) {
					
						case 'answer':
						
							dlog('got answer')
							rtcPlugin.handleAnswer(json.msgData.sdp);
							break;
						
						case 'candidate': 
								
							dlog('socket --> candidate');

							var cand = {
								candidate : json.msgData.candidate, 
								sdpMid : json.msgData.id, 
								sdpMLineIndex : json.msgData.label
							};
							
							rtcPlugin.handleCandidate(cand);

							break;
						case 'roomData': 

							alert('unexpected roomdata: ' + json.msgData.roomData);
							break;
						
						case 'offer': 
							dlog('got offer');

							rtcPlugin.handleOffer(json.senderEasyrtcid, json.msgData, function(sdp){
								dlog('returning answer');
								dlog(sdp);
								socket.emit('easyrtcCmd', { 
									msgType : "answer",
									targetEasyrtcid : rtcPlugin.remoteId,
									msgData : { sdp : sdp, type : "answer" }
								}, function() {
									dlog("answered");
								});
							});

							break;
						
						default:
						
							alert('unexpected message from easyrtc server ' + JSON.stringify(json));
							break;
						
						}
					}
				});

			});
		};

	};

	function addPeerButtons(message){
		dlog('authorizationCallback()');
		var rtcids = Object.keys(message.msgData.roomData.default.clientList);

		var htm = '';
		for(var i = 0; i < rtcids.length; i++) {
			var n = rtcids[i];
			if (n !== myrtcid)
				htm += '<button onclick="offer(\'' + n + '\')">' + n + '</button>';
		}
		if (htm !== ''){
			document.getElementById('divPeers').innerHTML = htm;
		}
		else{
			document.getElementById('divPeers').innerHTML += 'nobody else available'; //  at http://localhost:8080/demos/demo_audio_video_simple.html';
		}
	}

	function authenticate() {
		setupCallbacks();
	}

	function hangup() {
		rtcPlugin.close();
		socket.emit('easyrtcCmd', { "msgType" : "hangup", "targetEasyrtcid" : remotertcid } , function() { 
			dlog('hangup()');
		});
	}

	function debug() {
		rtcPlugin.nativeDebug();
	}

	function offer(remoteId) {
		// create the offer 
		rtcPlugin.createOffer(remoteId, function (sdp) {
			// send it off over signaling
			socket.emit('easyrtcCmd', { 
				msgType : "offer",
				targetEasyrtcid : remoteId,
				msgData : { sdp : sdp, type : "offer" }
			}, function offerCallbackComplete () {
				dlog('offerCallback()');

			});

		});
	}

	function run() {
		rtcPlugin = new RTCPlugin(element);
		rtcPlugin.run();
	}

	function dlog(text) {
		document.getElementById('divLog').innerHTML += text + '<br>';
	}

    </script>

</body>
</html>
